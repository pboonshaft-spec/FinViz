<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .upload-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: #eef1ff;
            border-color: #764ba2;
        }

        .upload-area input {
            display: none;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .debug-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
        }

        .debug-section h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .debug-content {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-change {
            font-size: 0.9rem;
            margin-top: 8px;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #ef4444;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ’° Financial Analytics Dashboard</h1>
            <p>Upload your financial CSV files to visualize your data</p>
        </div>

        <div class="upload-section">
            <div class="upload-area" onclick="document.getElementById('csvFile').click()">
                <input type="file" id="csvFile" accept=".csv" multiple>
                <div class="upload-icon">ðŸ“Š</div>
                <h3>Drop CSV files here or click to upload</h3>
                <p style="margin-top: 10px; color: #666;">Supports transactions, expenses, income, and budget data</p>
            </div>
        </div>

        <div id="debugSection" class="debug-section">
            <h3>ðŸ“‹ Data Detection Log</h3>
            <div id="debugContent" class="debug-content"></div>
        </div>

        <div id="statsContainer" class="stats-grid" style="display: none;"></div>
        <div id="chartsContainer" class="charts-grid" style="display: none;"></div>
        <div id="loading" class="loading" style="display: none;">Processing your data...</div>
    </div>

    <script>
        let financialData = [];
        let charts = {};
        let debugLog = [];

        function log(message) {
            debugLog.push(message);
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                debugContent.innerHTML = debugLog.join('<br>');
            }
        }

        document.getElementById('csvFile').addEventListener('change', handleFileUpload);

        function handleFileUpload(e) {
            const files = e.target.files;
            if (!files.length) return;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('debugSection').style.display = 'block';
            debugLog = [];
            financialData = [];

            log('Starting file upload...');

            let filesProcessed = 0;
            Array.from(files).forEach(file => {
                log(`Processing file: ${file.name}`);
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: false,
                    skipEmptyLines: true,
                    complete: (results) => {
                        log(`âœ“ Parsed ${file.name}: ${results.data.length} rows`);
                        log(`Headers: ${results.meta.fields.join(', ')}`);
                        
                        financialData.push({
                            filename: file.name,
                            data: results.data,
                            headers: results.meta.fields
                        });
                        
                        filesProcessed++;
                        if (filesProcessed === files.length) {
                            processData();
                        }
                    },
                    error: (error) => {
                        log(`âœ— Error parsing ${file.name}: ${error.message}`);
                        filesProcessed++;
                        if (filesProcessed === files.length) {
                            processData();
                        }
                    }
                });
            });
        }

        function processData() {
            document.getElementById('loading').style.display = 'none';
            
            if (financialData.length === 0) {
                alert('No data found in CSV files');
                return;
            }

            const allData = financialData.flatMap(f => f.data);
            log(`Total rows across all files: ${allData.length}`);
            
            const processed = detectAndProcessData(allData);
            
            log(`Processed transactions: ${processed.transactions.length}`);
            log(`Total Income: $${processed.totals.income.toFixed(2)}`);
            log(`Total Expenses: $${processed.totals.expenses.toFixed(2)}`);
            log(`Net Balance: $${processed.totals.balance.toFixed(2)}`);
            
            renderStats(processed);
            renderCharts(processed);
            
            document.getElementById('statsContainer').style.display = 'grid';
            document.getElementById('chartsContainer').style.display = 'grid';
        }

        function detectAndProcessData(data) {
            const sample = data[0];
            const headers = Object.keys(sample);
            
            log('Detecting column types...');
            
            let processed = {
                transactions: [],
                categories: {},
                monthlyData: {},
                dailyData: {},
                totals: {
                    income: 0,
                    expenses: 0,
                    balance: 0
                }
            };

            // Detect columns
            let dateCol = null;
            let amountCol = null;
            let debitCol = null;
            let creditCol = null;
            let categoryCol = null;
            let descriptionCol = null;

            headers.forEach(h => {
                const lower = h.toLowerCase().trim();
                if (lower.includes('date') || lower.includes('posted')) {
                    dateCol = h;
                    log(`Date column: "${h}"`);
                }
                if (lower === 'amount' || lower.includes('amount')) {
                    amountCol = h;
                    log(`Amount column: "${h}"`);
                }
                if (lower.includes('debit') || lower.includes('withdrawal')) {
                    debitCol = h;
                    log(`Debit column: "${h}"`);
                }
                if (lower.includes('credit') || lower.includes('deposit')) {
                    creditCol = h;
                    log(`Credit column: "${h}"`);
                }
                if (lower.includes('category') || lower === 'type') {
                    categoryCol = h;
                    log(`Category column: "${h}"`);
                }
                if (lower.includes('description') || lower.includes('merchant') || lower.includes('name')) {
                    descriptionCol = h;
                    log(`Description column: "${h}"`);
                }
            });

            // Process each row
            data.forEach((row, idx) => {
                // Get date
                let date = null;
                if (dateCol && row[dateCol]) {
                    date = new Date(row[dateCol]);
                    if (isNaN(date)) {
                        // Try different date formats
                        const dateStr = row[dateCol].toString();
                        date = new Date(dateStr.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$1-$2'));
                    }
                }

                if (!date || isNaN(date)) {
                    if (idx < 5) log(`âš  Row ${idx}: Invalid date "${row[dateCol]}"`);
                    return;
                }

                // Get amount - check for separate debit/credit columns first
                let amount = 0;
                let isExpense = false;

                if (debitCol && creditCol) {
                    // Separate debit/credit columns
                    const debitVal = parseFloat(String(row[debitCol] || '0').replace(/[$,]/g, ''));
                    const creditVal = parseFloat(String(row[creditCol] || '0').replace(/[$,]/g, ''));
                    
                    if (!isNaN(debitVal) && debitVal !== 0) {
                        amount = -Math.abs(debitVal); // Debits are expenses (negative)
                        isExpense = true;
                    } else if (!isNaN(creditVal) && creditVal !== 0) {
                        amount = Math.abs(creditVal); // Credits are income (positive)
                        isExpense = false;
                    }
                } else if (amountCol) {
                    // Single amount column
                    let rawAmount = String(row[amountCol] || '0').replace(/[$,]/g, '');
                    amount = parseFloat(rawAmount);
                    
                    if (isNaN(amount)) {
                        if (idx < 5) log(`âš  Row ${idx}: Invalid amount "${row[amountCol]}"`);
                        return;
                    }

                    // Determine if expense or income
                    // If amount is already negative, it's an expense
                    // If amount is positive, check category or description for expense indicators
                    if (amount < 0) {
                        isExpense = true;
                        amount = amount; // Keep negative
                    } else if (amount > 0) {
                        // Check if this should be classified as expense based on category
                        const category = (row[categoryCol] || '').toLowerCase();
                        const description = (row[descriptionCol] || '').toLowerCase();
                        const combined = category + ' ' + description;
                        
                        // Common expense keywords
                        const expenseKeywords = ['expense', 'payment', 'purchase', 'debit', 'withdrawal', 
                                                'grocery', 'restaurant', 'gas', 'utility', 'rent', 
                                                'subscription', 'shopping', 'amazon', 'store'];
                        const incomeKeywords = ['income', 'salary', 'deposit', 'credit', 'paycheck', 
                                               'payment received', 'transfer from', 'refund'];
                        
                        // Check for expense keywords
                        const hasExpenseKeyword = expenseKeywords.some(kw => combined.includes(kw));
                        const hasIncomeKeyword = incomeKeywords.some(kw => combined.includes(kw));
                        
                        if (hasExpenseKeyword && !hasIncomeKeyword) {
                            isExpense = true;
                            amount = -Math.abs(amount); // Make it negative
                        } else if (hasIncomeKeyword) {
                            isExpense = false;
                            amount = Math.abs(amount); // Keep positive
                        }
                        // If unclear, assume positive amounts are income by default
                    }
                }

                if (amount === 0) return;

                // Get category
                let category = row[categoryCol] || row[descriptionCol] || 'Uncategorized';
                category = String(category).trim();

                const month = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                const day = date.toISOString().split('T')[0];

                processed.transactions.push({
                    date: date,
                    amount: amount,
                    category: category,
                    month: month,
                    day: day,
                    isExpense: isExpense || amount < 0
                });

                // Categorize (only expenses go into categories chart)
                if (amount < 0) {
                    processed.categories[category] = (processed.categories[category] || 0) + Math.abs(amount);
                }

                // Monthly aggregation
                if (!processed.monthlyData[month]) {
                    processed.monthlyData[month] = { income: 0, expenses: 0, net: 0 };
                }
                
                if (amount > 0) {
                    processed.monthlyData[month].income += amount;
                    processed.totals.income += amount;
                } else {
                    processed.monthlyData[month].expenses += Math.abs(amount);
                    processed.totals.expenses += Math.abs(amount);
                }
                processed.monthlyData[month].net += amount;

                // Daily aggregation
                processed.dailyData[day] = (processed.dailyData[day] || 0) + amount;
            });

            processed.totals.balance = processed.totals.income - processed.totals.expenses;
            processed.transactions.sort((a, b) => a.date - b.date);

            return processed;
        }

        function renderStats(data) {
            const container = document.getElementById('statsContainer');
            const savingsRate = data.totals.income > 0 ? 
                ((data.totals.balance / data.totals.income) * 100).toFixed(1) : 0;
            
            const avgDaily = Object.values(data.dailyData).length > 0 ?
                (data.totals.expenses / Object.values(data.dailyData).length).toFixed(2) : 0;

            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Income</div>
                    <div class="stat-value">$${data.totals.income.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    <div class="stat-change positive">â†‘ Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Expenses</div>
                    <div class="stat-value" style="color: #ef4444;">$${data.totals.expenses.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    <div class="stat-change negative">â†“ Spending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Net Balance</div>
                    <div class="stat-value" style="color: ${data.totals.balance >= 0 ? '#10b981' : '#ef4444'}">
                        $${data.totals.balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </div>
                    <div class="stat-change ${data.totals.balance >= 0 ? 'positive' : 'negative'}">
                        ${data.totals.balance >= 0 ? 'â†‘' : 'â†“'} ${data.totals.balance >= 0 ? 'Surplus' : 'Deficit'}
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Savings Rate</div>
                    <div class="stat-value">${savingsRate}%</div>
                    <div class="stat-change ${savingsRate >= 20 ? 'positive' : 'negative'}">
                        ${savingsRate >= 20 ? 'â†‘ Great!' : 'â†“ Can improve'}
                    </div>
                </div>
            `;
        }

        function renderCharts(data) {
            const container = document.getElementById('chartsContainer');
            container.innerHTML = `
                <div class="chart-card full-width">
                    <div class="chart-title">Income vs Expenses Over Time</div>
                    <div id="timeSeriesChart"></div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Spending by Category</div>
                    <div id="categoryChart"></div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Monthly Cash Flow</div>
                    <div id="cashFlowChart"></div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Daily Spending Trend</div>
                    <div id="trendChart"></div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Income Distribution</div>
                    <div id="incomeDistChart"></div>
                </div>
            `;

            renderTimeSeriesChart(data);
            renderCategoryChart(data);
            renderCashFlowChart(data);
            renderTrendChart(data);
            renderIncomeDistChart(data);
        }

        function renderTimeSeriesChart(data) {
            const months = Object.keys(data.monthlyData);
            const income = months.map(m => data.monthlyData[m].income);
            const expenses = months.map(m => data.monthlyData[m].expenses);

            const options = {
                series: [{
                    name: 'Income',
                    data: income
                }, {
                    name: 'Expenses',
                    data: expenses
                }],
                chart: {
                    type: 'area',
                    height: 350,
                    toolbar: { show: true }
                },
                colors: ['#10b981', '#ef4444'],
                dataLabels: { enabled: false },
                stroke: { curve: 'smooth', width: 2 },
                fill: {
                    type: 'gradient',
                    gradient: {
                        opacityFrom: 0.6,
                        opacityTo: 0.1
                    }
                },
                xaxis: {
                    categories: months,
                    labels: { rotate: -45 }
                },
                yaxis: {
                    labels: {
                        formatter: (val) => '$' + val.toFixed(0)
                    }
                },
                tooltip: {
                    y: {
                        formatter: (val) => '$' + val.toFixed(2)
                    }
                },
                legend: {
                    position: 'top'
                }
            };

            const chart = new ApexCharts(document.querySelector("#timeSeriesChart"), options);
            chart.render();
            charts.timeSeries = chart;
        }

        function renderCategoryChart(data) {
            const categories = Object.keys(data.categories).slice(0, 10);
            const amounts = categories.map(c => data.categories[c]);

            if (amounts.length === 0) {
                document.querySelector("#categoryChart").innerHTML = '<p style="text-align:center;padding:40px;color:#999;">No expense categories found</p>';
                return;
            }

            const options = {
                series: amounts,
                chart: {
                    type: 'donut',
                    height: 380
                },
                labels: categories,
                colors: ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#fee140', '#30cfd0', '#a8edea', '#fed6e3'],
                legend: {
                    position: 'bottom',
                    fontSize: '12px'
                },
                dataLabels: {
                    enabled: true,
                    formatter: (val) => val.toFixed(1) + '%'
                },
                plotOptions: {
                    pie: {
                        donut: {
                            labels: {
                                show: true,
                                total: {
                                    show: true,
                                    label: 'Total Expenses',
                                    formatter: () => '$' + amounts.reduce((a, b) => a + b, 0).toFixed(0)
                                }
                            }
                        }
                    }
                },
                tooltip: {
                    y: {
                        formatter: (val) => '$' + val.toFixed(2)
                    }
                }
            };

            const chart = new ApexCharts(document.querySelector("#categoryChart"), options);
            chart.render();
            charts.category = chart;
        }

        function renderCashFlowChart(data) {
            const months = Object.keys(data.monthlyData);
            const netFlow = months.map(m => data.monthlyData[m].net);

            const options = {
                series: [{
                    name: 'Net Cash Flow',
                    data: netFlow
                }],
                chart: {
                    type: 'bar',
                    height: 350
                },
                colors: ['#667eea'],
                plotOptions: {
                    bar: {
                        distributed: true,
                        colors: {
                            ranges: [{
                                from: -100000,
                                to: 0,
                                color: '#ef4444'
                            }, {
                                from: 0.01,
                                to: 100000,
                                color: '#10b981'
                            }]
                        }
                    }
                },
                dataLabels: { enabled: false },
                xaxis: {
                    categories: months,
                    labels: { rotate: -45 }
                },
                yaxis: {
                    labels: {
                        formatter: (val) => '$' + val.toFixed(0)
                    }
                },
                tooltip: {
                    y: {
                        formatter: (val) => '$' + val.toFixed(2)
                    }
                },
                legend: {
                    show: false
                }
            };

            const chart = new ApexCharts(document.querySelector("#cashFlowChart"), options);
            chart.render();
            charts.cashFlow = chart;
        }

        function renderTrendChart(data) {
            const days = Object.keys(data.dailyData).sort();
            const amounts = days.map(d => data.dailyData[d]);

            const options = {
                series: [{
                    name: 'Daily Net',
                    data: amounts
                }],
                chart: {
                    type: 'line',
                    height: 350,
                    zoom: { enabled: true }
                },
                colors: ['#764ba2'],
                stroke: { curve: 'smooth', width: 3 },
                xaxis: {
                    type: 'datetime',
                    categories: days
                },
                yaxis: {
                    labels: {
                        formatter: (val) => '$' + val.toFixed(0)
                    }
                },
                tooltip: {
                    x: {
                        format: 'MMM dd, yyyy'
                    },
                    y: {
                        formatter: (val) => '$' + val.toFixed(2)
                    }
                }
            };

            const chart = new ApexCharts(document.querySelector("#trendChart"), options);
            chart.render();
            charts.trend = chart;
        }

        function renderIncomeDistChart(data) {
            const incomeTransactions = data.transactions.filter(t => t.amount > 0);
            const ranges = {
                '$0-100': 0,
                '$100-500': 0,
                '$500-1000': 0,
                '$1000-5000': 0,
                '$5000+': 0
            };

            incomeTransactions.forEach(t => {
                if (t.amount <= 100) ranges['$0-100']++;
                else if (t.amount <= 500) ranges['$100-500']++;
                else if (t.amount <= 1000) ranges['$500-1000']++;
                else if (t.amount <= 5000) ranges['$1000-5000']++;
                else ranges['$5000+']++;
            });

            const options = {
                series: [{
                    name: 'Count',
                    data: Object.values(ranges)
                }],
                chart: {
                    type: 'bar',
                    height: 350
                },
                colors: ['#10b981'],
                plotOptions: {
                    bar: {
                        horizontal: true,
                        distributed: false
                    }
                },
                dataLabels: { enabled: true },
                xaxis: {
                    categories: Object.keys(ranges)
                },
                yaxis: {
                    title: { text: 'Transaction Range' }
                }
            };

            const chart = new ApexCharts(document.querySelector("#incomeDistChart"), options);
            chart.render();
            charts.incomeDist = chart;
        }
    </script>
</body>
</html>
